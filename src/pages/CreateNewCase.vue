<script async setup>
// import TodoCatagoriDropdownComp from '../components/TodoCatagoriDropdownComp.vue';
import ProductOverview from '../components/ProductOverview.vue';

import CustomSelect from "@/components/shared/forms/CustomSelect.vue";
import CustomSelectItem from "@/components/shared/forms/CustomSelectItem.vue";
import BackButton from "@/components/shared/BackButton.vue";
import {FontAwesomeIcon} from "@fortawesome/vue-fontawesome";
import {ref} from 'vue';
import database from "@/database";
import router from "@/router";
import recursiveObjectSearch from "@/utilities/recursiveObjectSearch";
import comingSoonDialogue from "@/utilities/comingSoonDialogue";

const {data: statusOptions} = await database
    .from('statuses')
    .select('id, name')

const {data: employeeOptions} = await database.from('employees').select('id, name')

const {data: customerOptions} = await database.from('customers').select('id, name')
//
// const {data: tagsOptions} = await database.from('tags').select('id, name')
//
const {data: taskOptions} = await database.from('task_categories').select('id, name, tasks(*)').eq('tasks.one_off', false)

//
const {data: productOptions} = await database.from('products').select('id, name, sell_price')

const searchRef = ref("")

const selectedCustomer = ref(null)
const payee = ref(customerOptions[0])
const description = ref("")
const responsibleEmployee = ref(employeeOptions[0])
const pickupDate = ref(new Date())
const status = ref(statusOptions[0])
const price = ref(null)
const deposit = ref(0)

const currentTaskCategory = ref(taskOptions[0].id)

// const tags = ref([])
const selectedTasks = ref([])
// const products = ref([])

const parseDate = (event) => {
    const newDate = new Date(event.target.value);

    if (!isNaN(newDate.getTime())) {
        pickupDate.value = newDate;
    }
}

const getCurrentDateTimeString = () => {
    const toPaddedString = (number) => {
        return number.toString().padStart(2, '0')
    }

    const now = new Date()

    const year = now.getFullYear()

    const month = toPaddedString(now.getMonth() + 1)
    const day = toPaddedString(now.getDate())
    const hours = toPaddedString(now.getHours())
    const minutes = toPaddedString(now.getMinutes())

    return `${year}-${month}-${day}T${hours}:${minutes}`
}

const createCase = () => {
    database.from('cases').insert({
        created_by: 1,
        customer: selectedCustomer.value.id,
        payee: payee.value.id,
        description: description.value,
        responsible_employee: responsibleEmployee.value.id,
        pickup: pickupDate.value,
        status: status.value.id,
        negotiated_price: price.value,
        deposit: deposit.value,
    }).select().single().then(data => {
        // router.push({path: '/case/' + data.data.id})

        database.from("cases_tasks").insert(selectedTasks.value.map(task => {
            return {
                case_id: data.data.id,
                task_id: task.id,
            }
        })).then(() => {
            router.push({path: '/case/' + data.data.id})
        })
    })
}

const updateEmployee = (event) => {
    responsibleEmployee.value = employeeOptions.find(e => e.id === parseInt(event.target.value))
}

const updateStatus = (event) => {
    status.value = statusOptions.find(e => e.id === parseInt(event.target.value))
}

const switchCategory = (categoryId) => {
    currentTaskCategory.value = categoryId
}

const taskIsSelected = (task) => {
    return selectedTasks.value.some(t => t.id === task.id)
}

const toggleTask = (task) => {
    if (taskIsSelected(task)) {
        selectedTasks.value = selectedTasks.value.filter(t => t.id !== task.id)
    } else {
        selectedTasks.value.push(task)
    }
}


const countSelectedTasksInCategory = (category) => {
    return category.tasks.filter(task => taskIsSelected(task)).length
}

const showCustomTaskInput = ref(false)

const toggleCustomTask = () => {
    customTaskRef.value = ""
    showCustomTaskInput.value = !showCustomTaskInput.value
}

const customTaskRef = ref("")

const createCustomTask = () => {
    database.from("tasks").insert({
        name: customTaskRef.value,
        one_off: true,
    }).select().single().then(data => {
        console.log(data.data)
        selectedTasks.value.push(data.data)
        toggleCustomTask()
    })
}

const showPayeeOptions = ref(false)
const selectedPayee = ref(null)

const selectedProducts = ref([])

const addProduct = (product) => {
    selectedProducts.value.push(product)
}

const removeProduct = (product) => {
    selectedProducts.value = selectedProducts.value.filter(p => p.id !== product.id)
}
</script>

<template>
    <div class="header">
        <BackButton>Tilbage til sagsstyring</BackButton>
    </div>

    <div class="main-layout">
        <div class="main-left-content">
            <div class="main-content">
                <section class="customer">
                    <div class="customer-header">
                        <h3>Kunde</h3>

                        <p v-if="selectedCustomer && !showPayeeOptions" @click="showPayeeOptions = true">Anden
                            betaler</p>
                    </div>

                    <div v-if="!selectedCustomer" class="search-bar">
                        <div class="search-field">
                            <font-awesome-icon icon="magnifying-glass"/>
                            <input type="search" placeholder="Find kunde..." v-model="searchRef">
                        </div>

                        <p @click="comingSoonDialogue">Opret Ny Kunde</p>
                    </div>

                    <div v-if="!selectedCustomer && searchRef.length" class="customer-list">
                        <div v-for="customer in customerOptions.filter(c => recursiveObjectSearch(c, searchRef))"
                             @click="() => {
                                 selectedCustomer = customer
                                 searchRef = ''
                             }"
                             :key="customer.id">
                            <div class="customer-info">
                                <p>{{ customer.name }} <span class="customer-group">Kundegruppe</span></p>
                                <p>{{ customer.phone }}</p>
                            </div>

                            <div>
                                <p>{{ customer.address }}</p>

                                <p>
                                    <span>{{ customer.zipcode }}</span>
                                    <span>{{ customer.city }}</span>
                                </p>
                            </div>
                        </div>
                    </div>

                    <div v-if="selectedCustomer" class="selected-customer" @click="selectedCustomer = null">
                        <div>
                            <div class="customer-info">
                                <p>{{ selectedCustomer.name }} <span class="customer-group">Kundegruppe</span></p>
                                <p>{{ selectedCustomer.phone }}</p>
                            </div>

                            <div>
                                <p>{{ selectedCustomer.address }}</p>

                                <p>
                                    <span>{{ selectedCustomer.zipcode }}</span>
                                    <span>{{ selectedCustomer.city }}</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <section v-if="showPayeeOptions" class="payee">
                    <div class="customer-header">
                        <h3>Anden betaler</h3>
                    </div>

                    <div v-if="!selectedPayee" class="search-bar-container">
                        <div class="search-bar">
                            <div class="search-field">
                                <font-awesome-icon icon="magnifying-glass"/>
                                <input type="search" placeholder="Find kunde..." v-model="searchRef">
                            </div>

                            <p>Opret Ny Kunde</p>
                        </div>

                        <p v-if="selectedCustomer && !selectedPayee" @click="showPayeeOptions = false">Luk</p>
                    </div>

                    <div v-if="!selectedPayee && searchRef.length" class="customer-list">
                        <div v-for="customer in customerOptions.filter(c => recursiveObjectSearch(c, searchRef))"
                             @click="selectedPayee = customer"
                             :key="customer.id">
                            <div class="customer-info">
                                <p>{{ customer.name }} <span class="customer-group">Kundegruppe</span></p>
                                <p>{{ customer.phone }}</p>
                            </div>

                            <div>
                                <p>{{ customer.address }}</p>

                                <p>
                                    <span>{{ customer.zipcode }}</span>
                                    <span>{{ customer.city }}</span>
                                </p>
                            </div>
                        </div>
                    </div>

                    <div v-if="selectedPayee" class="selected-customer" @click="selectedPayee = null">
                        <div>
                            <div class="customer-info">
                                <p>{{ selectedPayee.name }} <span class="customer-group">Kundegruppe</span></p>
                                <p>{{ selectedPayee.phone }}</p>
                            </div>

                            <div>
                                <p>{{ selectedPayee.address }}</p>

                                <p>
                                    <span>{{ selectedPayee.zipcode }}</span>
                                    <span>{{ selectedPayee.city }}</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="todos">
                    <div class="title-bar">
                        <h3>Opgaver</h3>

                        <div>
                            <p v-if="!showCustomTaskInput" @click="toggleCustomTask">Tilpasset opgave</p>

                            <div v-else class="custom-task-input">
                                <input v-model="customTaskRef" type="text" placeholder="Indtast opgave">
                                <button @click="createCustomTask">Opret</button>

                                <p @click="toggleCustomTask">Luk</p>
                            </div>
                        </div>
                    </div>

                    <div class="section-bg">
                        <div class="todo-categories-list">
                            <div class="categories">
                                <div v-for="category in taskOptions" @click="switchCategory(category.id)"
                                     :key="category.id" class="category"
                                     :class="{selected: currentTaskCategory === category.id}">
                                    <p>{{ category.name }}</p>
                                    <small>{{ countSelectedTasksInCategory(category) }}</small>
                                </div>
                            </div>
                        </div>

                        <div class="task-selection-grid">
                            <div v-for="task in taskOptions.find(t => t.id === currentTaskCategory).tasks"
                                 :key="task.id" class="task" :class="{ selected: taskIsSelected(task) }"
                                 @click="toggleTask(task)">
                                <div class="checkbox">
                                    <font-awesome-icon icon="check" :class="{invisible: !taskIsSelected(task)}"/>
                                </div>

                                <p>{{ task.name }}</p>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <ProductOverview :add-product="addProduct" :remove-product="removeProduct"
                                     :selected-products="selectedProducts" :products="productOptions"/>
                </section>

                <section class="details">
                    <h3>Detaljer</h3>

                    <form class="grid-wrapper section-bg">
                        <div class="form-input">
                            <label for="">Ansvarlig</label>

                            <CustomSelect :callback="updateEmployee">
                                <CustomSelectItem v-for="employee in employeeOptions" :value="employee.id"
                                                  :key="employee.id">
                                    {{ employee.name }}
                                </CustomSelectItem>
                            </CustomSelect>
                        </div>

                        <div class="form-input">
                            <label for="">Status</label>

                            <CustomSelect :callback="updateStatus">
                                <CustomSelectItem v-for="status in statusOptions" :value="status.id"
                                                  :key="status.id">
                                    {{ status.name }}
                                </CustomSelectItem>
                            </CustomSelect>
                        </div>

                        <div class="form-input">
                            <label for="">Tags</label>

                            <!--                            <CustomSelect :multiple="true">-->
                            <!--                                <CustomSelectItem value="0">Vælg tags</CustomSelectItem>-->
                            <!--                                <CustomSelectItem value="1">Tag 1</CustomSelectItem>-->
                            <!--                                <CustomSelectItem value="2">Tag 2</CustomSelectItem>-->
                            <!--                            </CustomSelect>-->
                        </div>

                        <div class="flex-wrapper">
                            <div class="form-input">
                                <label for="">Afhentning</label>
                                <input @change="parseDate" :value="getCurrentDateTimeString()" class="input-field"
                                       type="datetime-local">
                            </div>

                            <div class="form-input">
                                <label for="">Aftalt Pris</label>

                                <div class="price-input">
                                    <input v-model="price" class="input-field" type="number" placeholder="Intern pris">
                                    <p>kr.</p>
                                </div>
                            </div>
                        </div>

                        <div class="form-input description">
                            <label for="">Beskrivelse</label>
                            <textarea v-model="description" class="input-field" name="" id="" cols="30"
                                      rows="10"></textarea>
                        </div>
                    </form>
                </section>
            </div>
        </div>

        <aside>
            <div class="section-bg">
                <h3>Opsummering</h3>

                <div class="summary">
                    <p v-if="selectedCustomer">
                        <span>Kunde: </span>
                        {{ selectedCustomer.name }}
                    </p>

                    <p v-if="selectedPayee">
                        <span>Betales af: </span>
                        {{ selectedPayee.name }}
                    </p>

                    <p v-if="responsibleEmployee">
                        <span>Ansvarlig: </span>
                        {{ responsibleEmployee.name }}
                    </p>

                    <p v-if="status">
                        <span>Status: </span>
                        {{ status.name }}
                    </p>

                    <p v-if="pickupDate">
                        <span>Afhentning: </span>
                        {{ pickupDate.toLocaleString() }}
                    </p>

                    <p v-if="price">
                        <span>Pris: </span>
                        {{ price }} kr.
                    </p>

                    <p v-if="description">
                        <span class="block">Beskrivelse: </span>
                        {{ description }}
                    </p>

                    <div v-if="selectedTasks">
                        <p><span>Opgaver:</span></p>

                        <ul class="selected-tasks">
                            <li v-for="task in selectedTasks" :key="task.id">
                                &nbsp;&nbsp;- {{ task.name }}
                                <span v-if="task.one_off"
                                      @click="selectedTasks = selectedTasks.filter(t => t.id !== task.id)">FJERN</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="create-task" @click="createCase()">
                <font-awesome-icon icon="plus"/>
                <p>Opret Sag</p>
            </div>

        </aside>
    </div>
</template>

<style lang="scss" scoped>
.selected-tasks {
    li {
        margin-block: 1rem;
    }
    span {
        cursor: pointer;
        margin-left: 0.5rem;
        font-size: 0.75rem;
        opacity: 0.65;

        &:hover {
            opacity: 1;
        }
    }
}

.customer-header {
  align-items: center;
  display: flex;
  justify-content: space-between;

  p {
    cursor: pointer;
    margin-bottom: 1rem;
    margin-right: 1rem;

    &:hover {
      text-decoration: underline;
    }
  }
}

.invisible {
  visibility: hidden;
}

.title-bar {
  display: flex;
  justify-content: space-between;

  p {
    margin-right: 1rem;
    cursor: pointer;

    &:hover {
      text-decoration: underline;
    }
  }
}

.task-selection-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem;

  .task {
    align-items: center;
    background-color: #fff;
    border-radius: var(--border-radius);
    cursor: pointer;
    display: flex;
    gap: 1rem;
    padding: var(--default-padding);

    &.selected {
      background-color: var(--bg-primary);
      color: var(--text-secondary);
    }

    .checkbox {
      align-items: center;
      border: 2px solid #ccc;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      padding: 0.25rem;

      svg {
        height: 1rem;
        width: 1rem;
      }
    }
  }
}

.summary {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  margin-top: 1rem;

  span {
    font-weight: 600;

    &.block {
      display: block;
      margin-bottom: 1rem;
    }
  }
}

.header {
  padding-bottom: 1rem;
}

.main-layout {
  display: flex;
  gap: 1rem;

  .main-left-content {
    width: 70%;
  }

  aside {
    align-items: stretch;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    height: fit-content;
    position: sticky;
    right: 0;
    top: 0;
    width: 30%;
  }
}

.main-content {
  display: flex;
  flex-direction: column;
  gap: 3rem;

  h3 {
    margin-bottom: 1rem;
  }
}

h3 {
  font-weight: 700;
  font-size: 1.125rem;
}

.search-bar-container {
    align-items: center;
    display: flex;
    justify-content: space-between;
    padding-right: 1rem;

    & > p {
        cursor: pointer;
        font-weight: 700;

        &:hover {
            text-decoration: underline;
        }
    }
}

.search-bar {
  align-items: center;
  display: flex;
  gap: 1rem;

  & > p {
    cursor: pointer;
    font-weight: 700;

    &:hover {
      text-decoration: underline;
    }
  }
}

.customer-list {
  background-color: var(--bg-secondary);
  border-radius: var(--border-radius);
  display: flex;
  flex-direction: column;
  gap: 1rem;
  padding: var(--default-padding);

  & > div {
    background-color: #fff;
    border-radius: var(--border-radius);
    padding: var(--default-padding);
    width: 100%;

    &:hover {
      background-color: var(--bg-primary);
      color: var(--text-secondary);
      cursor: pointer;
    }
  }
}

.selected-customer {
  background-color: var(--bg-secondary);
  border-radius: var(--border-radius);
  display: flex;
  padding: var(--default-padding);

  & > div {
    background-color: #fff;
    border-radius: var(--border-radius);
    padding: var(--default-padding);
    width: 100%;

    &:hover {
      background-color: var(--bg-primary);
      color: var(--text-secondary);
      cursor: pointer;
    }
  }
}


.customer-group {
  background-color: var(--bg-primary);
  border-radius: var(--border-radius);
  color: var(--text-secondary);
  padding: 0.55rem;
}

.customer-info {
  flex-grow: 1;
}

.search-bar {
  margin-bottom: 1rem;
}


.custom-task-input {
    align-items: center;
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;

    input {
        background-color: rgb(245 245 245);
        border-radius: var(--border-radius);
        padding: var(--default-padding);
    }

    button {
        background-color: var(--bg-primary);
        color: var(--text-secondary);
        cursor: pointer;
        padding: var(--default-padding);
    }
}

.search-field {
  align-items: center;
  background-color: rgb(245 245 245);
  border-radius: var(--border-radius);
  display: flex;
  gap: 1rem;
  padding-left: var(--default-padding);

  input {
    padding: var(--default-padding);
    padding-left: 0;
  }
}

.section-bg {
  padding: 1rem;
  background-color: rgb(209 213 219);
  border-radius: 0.125rem;
}

.todo-categories-list {
  display: flex;
  justify-content: space-between;
  margin-bottom: 1rem;

  .categories {
    align-items: center;
    display: flex;
    gap: 1rem;

    .category {
      align-items: center;
      background-color: #fff;
      border-radius: var(--border-radius);
      cursor: pointer;
      display: flex;
      gap: 2rem;
      padding: var(--default-padding);

      &.selected {
        background-color: var(--bg-primary);
        color: var(--text-secondary);
      }
    }
  }
}

.create-custom-todo {
  display: flex;
  gap: 1rem;
  background-color: white;
  padding: 1rem;
  border-radius: 0.125rem;
  cursor: pointer;
}

.grid-wrapper {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 1rem;

  .form-input {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;

    label {
      font-weight: 600;
    }

    .input-field {
      background-color: #fff;
      border-radius: var(--border-radius);
      padding: var(--default-padding);
    }
  }

  .description {
    grid-column: span 2;
  }
}

.flex-wrapper {
  display: flex;
  gap: 1rem;

  & > div {
    width: 100%;
  }
}


.price-input {
  position: relative;

  input {
    width: 100%;
    -moz-appearance: textfield;

    &::-webkit-outer-spin-button,
    &::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
  }

  p {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
  }
}

.create-task {
  align-items: center;
  display: flex;
  gap: 1rem;
  border-radius: 0.125rem;
  background-color: rgb(30 41 59);
  color: rgb(249 250 251);
  padding: 1rem;
  cursor: pointer;
  width: fit-content;
  align-self: end;

  &:hover {
    background-color: rgb(71 85 105);
  }
}
</style>